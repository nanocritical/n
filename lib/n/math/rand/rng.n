-- Uniform_u64 distribution
--
-- algorithm by
-- DP Mitchell and JA Reeds

let _LEN  = 607:Uint
let _TAP  = 273:Uint
let _A    = 48271:U32
let _M    = 0xffffffff:U64
let _Q    = 44488:U32
let _R    = 3399:U32

-- /dev/urandom numbers, see n/math/rand/utils/cook_rng.n
let rng_cooked = {
	\ 2983211271586915845 391735181736946868 1065902692544759017
	\ 12384407629983172193 9913331384162415905 14506189248485939542
	\ 13911702313464663668 15792305992852435990 12671965915230128954
	\ 12906296559439298439 7992613129091110094 10305938044777407923
	\ 6907116163180024923 529052804086646875 7612456935475068545
	\ 6561711528386733974 17415934656097595384 17811304427036025092
	\ 9682326540735713321 14669108919633905836 542904546838832359
	\ 10578309455529282597 494911495891854291 14983485281026231258
	\ 15584037689692751227 7721220495992793730 4294789613882727853
	\ 350060180996890240 427616061549480623 3138940415753194505
	\ 15999387785861810230 7524098409358118862 1828112147370416069
	\ 5651595408742717497 9899541404185934158 17558121085301026483
	\ 4998196533612886711 13698534107434783624 653181158407847367
	\ 10936967829381926618 2962569069758889992 11069874732582579892
	\ 11778287081492939949 5312939349515561864 13971740625334518016
	\ 4668191852320699911 11239704992911882856 1846908994842282391
	\ 11568687483905166555 1352825365115577050 8192150687039668425
	\ 6860402011448502235 12607519252648782346 15456863138797280696
	\ 14066861476951632149 5176579367773220856 13935693286713455615
	\ 12300929421044034338 1409911983950902098 16712104765676904835
	\ 17620929753028325387 6427169812944150387 3476683517597486484
	\ 16674806297984989672 9391336357794393239 4413435926931442218
	\ 8455340488934237744 419237929142516231 7661598859685231156
	\ 12863966425510056973 13447142244351239565 6637330748430570911
	\ 6682295484040757719 5382115315675658650 7926206751428875101
	\ 6366362210530702460 9492135537245608375 10792061822019692399
	\ 11419730843783147923 14756314695315481994 16562006014278964098
	\ 3065688198625340096 12925967277827957058 3273532359743607743
	\ 9608690990541851082 11565622635708638464 9909659810867339565
	\ 850376886014320727 16219292086662547357 16258345800982424524
	\ 18186098036868265452 98054327669140529 11794531993752372397
	\ 8748844958321630026 4193364923933496398 12117058471509570437
	\ 12857857935554657225 454368001237951430 2965227846198829815
	\ 10600861361175367972 2634326168579327289 1700340280508887419
	\ 7622283832897137283 5830232729866318027 5794114797139784607
	\ 705888326316908939 8594624168670297851 14231695785888188540
	\ 11753062172997165894 4731489429273780345 2186829814268957667
	\ 16644570849169401042 1725278877704428735 20431606354838511
	\ 6598953988727109484 7524721087142801573 14509554853827537765
	\ 9329165535226826560 7953467413306517020 16350849332793275634
	\ 5720802985185623670 11119115642008900945 8754462473314140566
	\ 10292998544078947903 923835732384773985 5908202028471725501
	\ 7330057433460163691 13376713263815633892 11548182829843317745
	\ 12745406264526293134 7861720295962498329 2002343998433175003
	\ 1731203711264377269 18175223984162338495 2703211141491742981
	\ 16769289838411034375 11577815309191938069 12782681603076685142
	\ 1697662271682296354 2342367102435969624 5397608824417970328
	\ 1047825457839758627 4719554011156601886 13568455568750491109
	\ 14954185397988739903 15790005019648046055 6821737304412943778
	\ 6710636579965711922 3254590682554236548 17627613467962503628
	\ 847977456691641725 13586013703143200220 13048212578314307179
	\ 3704040926439607644 9898645146222124384 9426724947148853401
	\ 18048999812732627518 1001205531190866016 3510646567960314851
	\ 4591659006634177082 5363635814168884632 4930473019921695236
	\ 17464373850128708093 11912062197651083784 4059646888044731798
	\ 1501548714956845194 15933067296441841264 13004397913917011383
	\ 16796000067621320705 1569046071352249169 658564702601784351
	\ 11863754826381553384 16655552985539766068 13832323687814854181
	\ 16193231636772946167 2114590498383814891 10112677049580918306
	\ 11773286405463903114 18108689414387030629 10758843371907249524
	\ 367270926400078519 10406632984569053357 12925412141340117399
	\ 14377003476037185109 12597025528395299907 3628783141449078868
	\ 8084454048317151867 2635796829707981384 14210023318613115055
	\ 9253812899705953933 9500193491588287435 13071873631177750471
	\ 5190215253368495191 18007538136246039971 3847883028859441163
	\ 7981381590876952724 18341166898346030331 10573745152048605409
	\ 14360754825669377630 16950485711251729147 11767469352940880722
	\ 12994611128702361510 5163666442418450945 3801761131023026431
	\ 17954458116094646397 3937591977710605930 6931334525936803987
	\ 7545174989755133494 9270972459871334948 3349976039320433124
	\ 16667105096409388513 17913093177931597346 17874703252687038950
	\ 11910507110929819732 17240759118363463900 4698953310098679257
	\ 3023044046243734768 7337932246543549842 588467794503912352
	\ 3328730104906732905 4045278663839560780 9296294493469402647
	\ 15738415968554632067 2756980964077145633 18371641035809976033
	\ 302960448802689998 5634305469206701394 5967843792946485200
	\ 8821235392024344860 10750528243045138007 17284249083784656105
	\ 14585866530044274201 3119698652939702128 4727429066746837438
	\ 3847048862182893124 13273825240131328636 1128072534103941587
	\ 6945871122607738393 5843542552167074980 15048809686388697867
	\ 13084011727068166710 1759057966035248997 2905732723253903043
	\ 3803001028106209107 17124514963484298439 13807042915379735124
	\ 15250327476999734346 9937604594982890063 540555493170020642
	\ 2012172632998870785 10204410069308752713 13710356972951288407
	\ 4021203790804769298 4041882401928545676 15413996888948622174
	\ 8428806843080837149 10202598679124605618 11176051467272070833
	\ 14376188588152573080 13835278395025808022 8718052120259846313
	\ 9712844633074263695 4276831609836877000 14342177040670241578
	\ 17387620605858100262 10949105979436580571 13819075461829295067
	\ 8364624156209236195 7343914784123628457 14515537230892270535
	\ 11624873503143440748 16686827469716121147 6729676904476452520
	\ 753348718917799955 10807590247608818012 15221066244840499182
	\ 13334432944137871370 7439420464468295386 13585011816472369121
	\ 9040001728302070070 13853977936171999834 4356692553467916404
	\ 7179344752697660245 10508652100990076954 12743351299761565966
	\ 7550478447834807592 3492966705813765891 5438565635873978678
	\ 17989608132407687117 9398023597820477990 14509367824090515250
	\ 3759463061488361776 4498603079235440859 15598462489740900034
	\ 13854232564652321898 9385509206492711291 4719186654027968065
	\ 2666954369187575725 10537022480022421149 984703573522551139
	\ 13280896928217716764 332510748285982006 14360776892880127817
	\ 12046459875123233359 13676779387679587926 8583133940976806843
	\ 13886752459802277900 6248111519136219039 5795426636571791386
	\ 7010463999507901490 12412880890415385722 106313750845995641
	\ 8058283836546077466 10987090653979725892 8927394096248039591
	\ 10675995483659841149 17235113741016304341 15213677731628010432
	\ 9285297777713323201 7078610807302235914 9161366469185467653
	\ 7684494855296947021 10696090469314731422 8444485711773218008
	\ 13758755352700745125 14444649431706592205 8614684359075233642
	\ 12466805392525188006 4263775452500992561 507822540425666678
	\ 17255052198786086604 17484743197135216200 13539848630374867828
	\ 14394496221153076423 11221112042863005232 3181487277091438142
	\ 13182293755006861910 4819405550949421182 8507632715308467006
	\ 9925142753521146892 13847519313771161055 11560803742021429852
	\ 13861330108260764308 6318966716479306891 10547819168370539465
	\ 15045847700852573217 11521775876286120952 18272884763868098085
	\ 10406762395754619323 9361086072058216916 14098957546041115753
	\ 14326202550338827914 230670050298641221 5086818639596776072
	\ 10717996255084609149 10271937585475526724 17547473982170179370
	\ 5082268439320227783 5978726123821730297 7196406104079851045
	\ 16601168170298422932 5877298140103426619 11085254024371887150
	\ 17128865387601856198 16013473419831054019 14675765569104440412
	\ 5683255387043187776 15764096368055841955 10164616822692746403
	\ 3695761500719363739 9045767248164484289 14513358661688085906
	\ 668927715862412597 17658346482459854746 13734361155763310475
	\ 5946553355478231566 17704602937545603362 11819326743570953636
	\ 9274890748157316410 6393178402201151874 14868780034722837105
	\ 6107250813507513501 11975373983769064307 6355317865375408128
	\ 15005982409606502215 8635464445719915681 10800737258600007491
	\ 1005566219838847545 13644041508106711307 12033977883689934427
	\ 14567413256348115362 12454821696952125957 13791568748511186377
	\ 17411875294553213936 9102925074762876444 2619379295127098406
	\ 10179121840726091440 1560656466155176172 3909372925290902086
	\ 7817283431855481030 4888578801087297056 3100806032016864363
	\ 3038948706113393817 2048637023570197252 13402442404100817430
	\ 2270127498883320211 17939266640553031073 11298884653494315797
	\ 1486540785354092035 15769308798940627193 17534860928539666980
	\ 18345111601943817852 7151787350217617207 2788735504603685598
	\ 16961348800364171244 13908274258568483139 11519101956768493317
	\ 4895792125551640257 3006572751416096692 7741375134358936724
	\ 3735873523587432691 227154189533037841 12482780431214858126
	\ 9151951010974018371 13483611186045150616 6111157446633878847
	\ 16424469605411625888 14166506438767471227 13986803282683319102
	\ 361343281679646500 18050402920564737333 1002658559193050917
	\ 8502945636675154915 525279652941933376 10975483238993400307
	\ 1380362962755985724 17974426442390378920 3616259617645870492
	\ 1305895426421432945 610480160887619888 7525304083116244502
	\ 15642518131195341594 4531580759264640553 7090732038250083093
	\ 13891616558599057380 10942392626137948603 8968589944382529663
	\ 10845434427394733134 17790129819131351063 9919461375244017629
	\ 4543080067708767721 6893534099988289106 12767428559905706702
	\ 3469199414098781395 17289922826009905851 16577034739115187780
	\ 3818652503591945945 6019515789844901289 11360667135242573705
	\ 3637612403057400724 7534480872694804504 15525746503382727986
	\ 2205140155002357512 12267827335292466756 15137917754521444903
	\ 17681526337715901353 10389611880430623813 85604182014469556
	\ 15596345888876754024 16801597726690775409 6331202348238347391
	\ 16227739758066841233 14996571785510846019 7845832847521026330
	\ 7228407950248963051 11683789028948942500 10356827865354021530
	\ 9041343858498187462 3076133699828113898 6352483221505318966
	\ 9392507842298929265 630868643246283035 4428643384499451278
	\ 18238418713853592715 8141708086510125362 2951580328630971200
	\ 4295137834215376245 16297610727734755590 8412878503713745893
	\ 6576856074468201267 8064890137740151781 13457848882089802615
	\ 13587121113058340403 5929589137701331728 11177825606645013841
	\ 5632657251764998119 15256885131639349712 150901865660250394
	\ 12307182664017388423 14172776668987769109 9282338270672916991
	\ 13842525403712748591 7339368059428649592 179034358739041215
	\ 6733036475869798804 10663685530662500116 779556687489322260
	\ 2128661385124043767 16437376167429327893 11675571514433567726
	\ 2273846982373350724 2953403375178732692 1694077810007376542
	\ 12204665550479961314 5807625002750072907 7117365300362974514
	\ 7566824708816156660 4535119397367576247 877753378949647323
	\ 6155535187200781393 17060926584315538775 1021745675710965178
	\ 10283815240667981743 5722520019199805380 2411461569979016741
	\ 5042932528569651278 3860795629446029773 13055242629033585122
	\ 11183567601914033445 8529164960156188452 2868571239764907730
	\ 8867372219981157997 9702778299329058954 11719099273976925513
	\ 5161916316161303891 11978897002453925138 10625475777084505444
	\ 1854370353140758573 9931017212075059752 13519082864347778598
	\ 15636500191916730407 2618595712775055765 12669530551730427571
	\ 11480571693995653903 10395897204243998543 13950143220194238687
	\ 16436399340752246356 11662977857538955921 9303924802403619647
	\ 18059902159651829772 17914391066021057086 4436765865177251861
	\ 15014624120001420315 17256828786708217123 3686918466601158540
	\ 17036364857255158137 13097066096228225057 3094055292186263587
	\ 17408563100594125855 16610820512477368256 1195006107154400069
	\ 6615603752868480666 13947399920523590173 2141118901562169685
	\ 30228199559209935 5379859154681154599 6283704003658681413
	\ 6474718501537831903 15928192513112443182 4995202374554002713
	\ 18407671656951554328 2102267389458121293 15568066364205479351
	\ 11742272723257462176 17270366442150240959 1282499365570078102
	\ 9132813133779842712 8364725791849515553 71607605452603508
	\ 15548328200805589139 6105819619420885038 9368174984795387621
	\ 5055032896259818943 14472627325396885369 5348945038360082249
	\ 611600476126320208 5614392936680046538 17533922433440841753
	\ 4389262466766373694 3545975704099588465 16239251475328339754
	\ 10300049268786045702 18033030603333955581 8558059629947354723
	\ 15993341122173713826 2185780196388095377 1096612400873683922
	\ 13754962858336009117 15674665065689102269 8510463028338175198
	\ 11593214278061366669 278620389745698574 10418501079686692487
	\ 15103682207280163490 5729775868467011689 13262728020618129108
	\ 9068525441506126588 }:[]U64

struct rng_source =
	isa `Source
	tap	:Uint		-- index into vec
	feed	:Uint		-- index into vec
	vec	:(Buf U64)	-- current feedback register

-- seed rng x[n+1] = 48271 * x[n] mod (2**31 - 1)
fun seedrand x:U32 = U32
	let hi = x / _Q
	let lo = x % _Q
	x = _A*lo - _R*hi
	return x

-- Seed uses the provided seed value to initialize the generator to a deterministic state.
rng_source met! Seed seed:U64
	self!vec#Resize rng_cooked.Count

	self!tap = 0
	self!feed = _LEN - _TAP

	seed = seed % _M
	if seed == 0
		seed = 89482311

	var x = seed.Trim_u32
	let prelim = 20
	foreach i over 0 .. _LEN+prelim
		x = seedrand x
		if i >= prelim
			var u = x.U64 ov<< 40
			x = seedrand x
			u ^= x.U64 ov<< 20
			x = seedrand x
			u ^= x.U64
			u ^= rng_cooked.[i-prelim]
			self!vec![i-prelim]! = u

-- Uniform_u64 returns a pseudo-random 64-bit integer as an U64.
rng_source met! Uniform_u64 = U64
	if self.tap == 0
		self!tap += _LEN
	self!tap -= 1

	if self.feed == 0
		self!feed += _LEN
	self!feed -= 1

	let x = self.vec.[self.feed] + self.vec.[self.tap]
	self!vec![self.feed]! = x
	return x
